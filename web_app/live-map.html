<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Traffic Map - Kottravel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #trafficMap {
            height: 70vh;
            border-radius: 12px;
            z-index: 1;
            position: relative;
        }
        .map-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            max-width: 250px;
        }
        .prediction-banner {
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .congestion-indicator {
            transition: all 0.3s ease;
        }
        .congestion-indicator:hover {
            transform: scale(1.05);
        }
        
        /* Ensure proper spacing between sections */
        section {
            position: relative;
        }
        
        /* Prevent map controls from overlapping on small screens */
        @media (max-width: 768px) {
            .map-controls {
                max-width: 200px;
                font-size: 0.875rem;
                padding: 12px;
            }
            
            #trafficMap {
                height: 60vh;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center">
                        <i data-feather="compass" class="text-green-600"></i>
                        <span class="ml-2 font-bold text-gray-900">Kottravel</span>
                    </div>
                </div>
                <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                    <a href="index.html" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Home</a>
                    <a href="weather-map.html" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Weather Map</a>
                    <a href="live-map.html" class="border-green-500 text-gray-900 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Live Map</a>
                    <a href="report.html" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Report Issue</a>
                    <a href="dashboard.html" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Dashboard</a>
                    <a href="karma.html" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Karma</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Congestion Prediction Banner -->
    <div id="predictionBanner" class="prediction-banner bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 px-4">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center">
                <i data-feather="trending-up" class="w-5 h-5 mr-2"></i>
                <span class="font-medium">ðŸ§  AI Congestion Prediction:</span>
                <span id="predictionText" class="ml-2">Loading prediction...</span>
            </div>
            <button onclick="hidePredictionBanner()" class="text-white hover:text-gray-200">
                <i data-feather="x" class="w-4 h-4"></i>
            </button>
        </div>
    </div>

    <!-- Header -->
    <section class="py-8 bg-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="lg:text-center">
                <h1 class="text-3xl font-extrabold tracking-tight text-gray-900 sm:text-4xl">
                    ðŸ—º Live Traffic Map
                </h1>
                <p class="mt-3 max-w-2xl text-xl text-gray-500 lg:mx-auto">
                    Real-time traffic conditions with heatmaps and AI-powered congestion predictions for Kottakkal.
                </p>
            </div>
        </div>
    </section>

    <!-- Live Map Section -->
    <section class="py-8 bg-gray-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="relative">
                <!-- Map Controls -->
                <div class="map-controls">
                    <h3 class="font-semibold text-gray-900 mb-3">Map Layers</h3>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" id="trafficLayer" checked class="mr-2">
                            <span class="text-sm text-gray-700">Traffic Flow</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="heatmapLayer" class="mr-2">
                            <span class="text-sm text-gray-700">Heatmap</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="incidentLayer" checked class="mr-2">
                            <span class="text-sm text-gray-700">Incidents</span>
                        </label>
                    </div>
                    
                    <div class="mt-4 pt-3 border-t border-gray-200">
                        <h4 class="font-medium text-gray-900 mb-2">Legend</h4>
                        <div class="space-y-1 text-xs">
                            <div class="flex items-center">
                                <span class="w-3 h-3 rounded-full bg-green-500 mr-2"></span>
                                <span class="text-gray-700">Free flowing</span>
                            </div>
                            <div class="flex items-center">
                                <span class="w-3 h-3 rounded-full bg-orange-500 mr-2"></span>
                                <span class="text-gray-700">Moderate</span>
                            </div>
                            <div class="flex items-center">
                                <span class="w-3 h-3 rounded-full bg-red-500 mr-2"></span>
                                <span class="text-gray-700">Congested</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Live Map -->
                <div id="trafficMap" class="rounded-xl shadow-lg"></div>
            </div>
        </div>
    </section>

    <!-- Multi-Webcam Feeds Section -->
    <section class="py-8 bg-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">ðŸ“¸ Multi-Webcam Feeds</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white rounded-lg p-4 shadow border border-gray-200">
                    <h3 class="text-lg font-semibold mb-2">Camera 1</h3>
                    <video id="video1" autoplay playsinline class="w-full rounded shadow" style="max-height: 300px;"></video>
                </div>
                <div class="bg-white rounded-lg p-4 shadow border border-gray-200">
                    <h3 class="text-lg font-semibold mb-2">Camera 2</h3>
                    <video id="video2" autoplay playsinline class="w-full rounded shadow" style="max-height: 300px;"></video>
                </div>
                <div class="bg-white rounded-lg p-4 shadow border border-gray-200">
                    <h3 class="text-lg font-semibold mb-2">Camera 3</h3>
                    <video id="video3" autoplay playsinline class="w-full rounded shadow" style="max-height: 300px;"></video>
                </div>
            </div>
        </div>
    </section>

    <!-- Top Congested Roads Section -->
    <section class="py-8 bg-gray-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">ðŸš¦ Top Congested Roads</h2>
            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="space-y-4">
                    <div class="flex items-center justify-between p-4 bg-red-50 rounded-lg border border-red-200">
                        <div class="flex items-center">
                            <span class="w-4 h-4 rounded-full bg-red-500 mr-3"></span>
                            <div>
                                <h3 class="font-semibold text-red-900">NH 66 - Near Medical College</h3>
                                <p class="text-sm text-red-700">High congestion due to medical traffic</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="text-lg font-bold text-red-900">2.4 km</span>
                            <p class="text-sm text-red-700">delay</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between p-4 bg-orange-50 rounded-lg border border-orange-200">
                        <div class="flex items-center">
                            <span class="w-4 h-4 rounded-full bg-orange-500 mr-3"></span>
                            <div>
                                <h3 class="font-semibold text-orange-900">Kottakkal Bypass Road</h3>
                                <p class="text-sm text-orange-700">Moderate traffic during peak hours</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="text-lg font-bold text-orange-900">1.2 km</span>
                            <p class="text-sm text-orange-700">delay</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between p-4 bg-orange-50 rounded-lg border border-orange-200">
                        <div class="flex items-center">
                            <span class="w-4 h-4 rounded-full bg-orange-500 mr-3"></span>
                            <div>
                                <h3 class="font-semibold text-orange-900">Main Bazaar Road</h3>
                                <p class="text-sm text-orange-700">Shopping district traffic</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="text-lg font-bold text-orange-900">0.8 km</span>
                            <p class="text-sm text-orange-700">delay</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                        <div class="flex items-center">
                            <span class="w-4 h-4 rounded-full bg-yellow-500 mr-3"></span>
                            <div>
                                <h3 class="font-semibold text-yellow-900">Airport Road</h3>
                                <p class="text-sm text-yellow-700">Light congestion</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="text-lg font-bold text-yellow-900">0.5 km</span>
                            <p class="text-sm text-yellow-700">delay</p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 pt-4 border-t border-gray-200">
                    <div class="flex items-center justify-between text-sm text-gray-600">
                        <span>Last updated: <span id="lastUpdated">Just now</span></span>
                        <button onclick="refreshCongestedRoads()" class="text-green-600 hover:text-green-700 flex items-center">
                            <i data-feather="refresh-cw" class="w-4 h-4 mr-1"></i>
                            Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Traffic Stats -->
    <section class="py-8 bg-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Real-time Traffic Statistics</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <!-- Average Speed -->
                <div class="bg-gray-50 rounded-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Average Speed</p>
                            <p class="text-3xl font-bold text-gray-900">32 km/h</p>
                        </div>
                        <div class="text-green-500">
                            <i data-feather="trending-up" class="w-8 h-8"></i>
                        </div>
                    </div>
                    <p class="text-sm text-green-600 mt-2">+12% from yesterday</p>
                </div>

                <!-- Active Incidents -->
                <div class="bg-gray-50 rounded-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Active Incidents</p>
                            <p class="text-3xl font-bold text-gray-900">8</p>
                        </div>
                        <div class="text-orange-500">
                            <i data-feather="alert-triangle" class="w-8 h-8"></i>
                        </div>
                    </div>
                    <p class="text-sm text-orange-600 mt-2">3 new in last hour</p>
                </div>

                <!-- Congestion Level -->
                <div class="bg-gray-50 rounded-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Congestion Level</p>
                            <p class="text-3xl font-bold text-gray-900">45%</p>
                        </div>
                        <div class="text-blue-500">
                            <i data-feather="activity" class="w-8 h-8"></i>
                        </div>
                    </div>
                    <p class="text-sm text-blue-600 mt-2">Moderate traffic</p>
                </div>

                <!-- Travel Time -->
                <div class="bg-gray-50 rounded-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Avg. Travel Time</p>
                            <p class="text-3xl font-bold text-gray-900">18 min</p>
                        </div>
                        <div class="text-purple-500">
                            <i data-feather="clock" class="w-8 h-8"></i>
                        </div>
                    </div>
                    <p class="text-sm text-purple-600 mt-2">-5 min from usual</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200">
        <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center">
                <p class="text-gray-500">Â© 2023 Smart Traffic Monitor â€“ Kottakkal. Real-time data updates every 30 seconds.</p>
                <a href="index.html" class="text-green-600 hover:text-green-700">Back to Home</a>
            </div>
        </div>
    </footer>

    <script>
        // Initialize Feather Icons
        feather.replace();

        // Map and data variables
        let map;
        let heatmapLayer;
        let trafficLayer;
        let incidentLayer;

        // Kottakkal coordinates
        const KOTTAKKAL_COORDS = [10.9942, 76.0062];

        // Mock traffic data
        const trafficData = [
            { lat: 10.9942, lng: 76.0062, intensity: 0.8, type: 'congested' },
            { lat: 10.9842, lng: 76.0162, intensity: 0.6, type: 'moderate' },
            { lat: 11.0042, lng: 75.9962, intensity: 0.9, type: 'congested' },
            { lat: 10.9742, lng: 76.0262, intensity: 0.3, type: 'free' },
            { lat: 11.0142, lng: 75.9862, intensity: 0.7, type: 'moderate' }
        ];

        // Mock incident data
        const incidentData = [
            { lat: 10.9942, lng: 76.0062, type: 'accident', description: 'Minor collision' },
            { lat: 10.9842, lng: 76.0162, type: 'pothole', description: 'Large pothole' },
            { lat: 11.0042, lng: 75.9962, type: 'roadblock', description: 'Construction work' }
        ];

        // Initialize map
        function initMap() {
            map = L.map('trafficMap').setView(KOTTAKKAL_COORDS, 13);

            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            // Initialize layers
            initTrafficLayer();
            initHeatmapLayer();
            initIncidentLayer();

            // Load initial data
            loadTrafficData();
            updateCongestionPrediction();
            updateCongestedRoads();

            // Auto-refresh every 30 seconds
            setInterval(loadTrafficData, 30000);
        }

        // Initialize traffic layer
        function initTrafficLayer() {
            trafficLayer = L.layerGroup().addTo(map);
        }

        // Initialize heatmap layer
        function initHeatmapLayer() {
            const heatmapData = trafficData.map(point => [point.lat, point.lng, point.intensity * 100]);
            heatmapLayer = L.heatLayer(heatmapData, {
                radius: 50,
                blur: 30,
                maxZoom: 10,
                gradient: {
                    0.4: 'green',
                    0.6: 'orange',
                    0.8: 'red'
                }
            });
        }

        // Initialize incident layer
        function initIncidentLayer() {
            incidentLayer = L.layerGroup().addTo(map);
        }

        // Load traffic data
        function loadTrafficData() {
            // Clear existing markers
            trafficLayer.clearLayers();
            incidentLayer.clearLayers();

            // Add traffic flow markers
            trafficData.forEach(point => {
                const color = getTrafficColor(point.type);
                const marker = L.circleMarker([point.lat, point.lng], {
                    radius: 8,
                    fillColor: color,
                    color: color,
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(trafficLayer);

                marker.bindPopup(`
                    <div class="text-center">
                        <h3 class="font-semibold">${point.type.toUpperCase()} TRAFFIC</h3>
                        <p class="text-sm">Intensity: ${Math.round(point.intensity * 100)}%</p>
                    </div>
                `);
            });

            // Add incident markers
            incidentData.forEach(incident => {
                const icon = getIncidentIcon(incident.type);
                const marker = L.marker([incident.lat, incident.lng], { icon: icon }).addTo(incidentLayer);

                marker.bindPopup(`
                    <div class="text-center">
                        <h3 class="font-semibold">${incident.type.toUpperCase()}</h3>
                        <p class="text-sm">${incident.description}</p>
                    </div>
                `);
            });
        }

        // Get traffic color based on type
        function getTrafficColor(type) {
            const colors = {
                'free': '#10B981',
                'moderate': '#F59E0B',
                'congested': '#EF4444'
            };
            return colors[type] || '#6B7280';
        }

        // Get incident icon
        function getIncidentIcon(type) {
            const icons = {
                'accident': 'ðŸš—',
                'pothole': 'ðŸ•³',
                'roadblock': 'ðŸš§',
                'flooding': 'ðŸŒŠ'
            };
            return L.divIcon({
                html: `<div style="font-size: 20px;">${icons[type] || 'âš '}</div>`,
                className: 'incident-icon',
                iconSize: [20, 20]
            });
        }

        // Update congestion prediction
        function updateCongestionPrediction() {
            const hour = new Date().getHours();
            let prediction = "Free flowing";
            let emoji = "ðŸŸ¢";
            
            if (hour >= 8 && hour <= 10) {
                prediction = "High Traffic Expected";
                emoji = "ðŸŸ ";
            } else if (hour >= 17 && hour <= 19) {
                prediction = "Peak Hour Congestion";
                emoji = "ðŸ”´";
            } else if (hour >= 22 || hour <= 6) {
                prediction = "Light Traffic";
                emoji = "ðŸŸ¢";
            }

            document.getElementById('predictionText').innerHTML = `${emoji} ${prediction} (${hour}:00)`;
        }

        // Update congested roads list
        function updateCongestedRoads() {
            const congestedRoads = [
                { name: 'NH 66 - Near Medical College', delay: '2.4 km', severity: 'high' },
                { name: 'Kottakkal Bypass Road', delay: '1.2 km', severity: 'medium' },
                { name: 'Main Bazaar Road', delay: '0.8 km', severity: 'medium' },
                { name: 'Airport Road', delay: '0.5 km', severity: 'low' }
            ];

            // Update the last updated time
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true 
            });
            document.getElementById('lastUpdated').textContent = timeString;
        }

        // Get severity class
        function getSeverityClass(severity) {
            const classes = {
                'high': 'bg-red-50',
                'medium': 'bg-orange-50',
                'low': 'bg-yellow-50'
            };
            return classes[severity] || 'bg-gray-50';
        }

        // Get severity color
        function getSeverityColor(severity) {
            const colors = {
                'high': 'bg-red-500',
                'medium': 'bg-orange-500',
                'low': 'bg-yellow-500'
            };
            return colors[severity] || 'bg-gray-500';
        }

        // Refresh congested roads data
        function refreshCongestedRoads() {
            // Simulate refreshing data
            const button = event.target.closest('button');
            const icon = button.querySelector('i');
            
            // Disable button during refresh
            button.disabled = true;
            button.classList.add('opacity-50');
            
            // Add spinning animation
            icon.style.transform = 'rotate(360deg)';
            icon.style.transition = 'transform 0.5s ease';
            
            setTimeout(() => {
                updateCongestedRoads();
                icon.style.transform = 'rotate(0deg)';
                button.disabled = false;
                button.classList.remove('opacity-50');
            }, 1000);
        }

        // Hide prediction banner
        function hidePredictionBanner() {
            document.getElementById('predictionBanner').style.display = 'none';
        }

        // Layer control event listeners
        document.getElementById('trafficLayer').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(trafficLayer);
            } else {
                map.removeLayer(trafficLayer);
            }
        });

        document.getElementById('heatmapLayer').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(heatmapLayer);
            } else {
                map.removeLayer(heatmapLayer);
            }
        });

        document.getElementById('incidentLayer').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(incidentLayer);
            } else {
                map.removeLayer(incidentLayer);
            }
        });

        // Initialize when page loads
        window.addEventListener('load', initMap);
      
        async function setupWebcams() {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(device => device.kind === 'videoinput');
            const videoElements = ["video1", "video2", "video3"];

            for (let i = 0; i < Math.min(3, videoDevices.length); i++) {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { deviceId: { exact: videoDevices[i].deviceId } },
                    audio: false
                });
                document.getElementById(videoElements[i]).srcObject = stream;
            }
        }
        window.addEventListener('DOMContentLoaded', setupWebcams);
    </script>
</body>
</html>