<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Report Issue - Kottravel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .stepper-circle {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: bold;
        }
        .stepper-active {
            background-color: #3CB371;
            color: white;
        }
        .stepper-inactive {
            background-color: #E2E8F0;
            color: #64748B;
        }
        .issue-tile {
            transition: all 0.2s ease;
        }
        .issue-tile:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
        }
        .speech-indicator {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .offline-indicator {
            background: linear-gradient(45deg, #EF4444, #DC2626);
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }
        
        .pin-pulse {
            animation: pinPulse 2s infinite;
        }
        @keyframes pinPulse {
            0%, 100% { 
                transform: scale(1);
                opacity: 1;
            }
            50% { 
                transform: scale(1.05);
                opacity: 0.8;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center">
                        <i data-feather="compass" class="text-green-600"></i>
                        <span class="ml-2 font-bold text-gray-900">Kottravel</span>
                    </div>
                </div>
                <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                    <a href="index.html" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Home</a>
                    <a href="weather-map.html" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Weather Map</a>
                    <a href="live-map.html" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Live Map</a>
                    <a href="report.html" class="border-green-500 text-gray-900 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Report Issue</a>
                    <a href="dashboard.html" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Dashboard</a>
                    <a href="karma.html" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Karma</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Offline Indicator -->
    <div id="offlineIndicator" class="offline-indicator text-white py-2 px-4 text-center font-medium hidden">
        üß≠ You're offline. Reports will be saved and synced when connection returns.
    </div>

    <!-- Header -->
    <section class="py-8 bg-white">
        <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="lg:text-center">
                <h1 class="text-3xl font-extrabold tracking-tight text-gray-900 sm:text-4xl">
                    üîî Smart Issue Reporting
                </h1>
                <p class="mt-3 max-w-2xl text-xl text-gray-500 lg:mx-auto">
                    Report traffic issues with speech-to-text, offline support, and AI-powered fake report detection.
                </p>
            </div>
        </div>
    </section>

    <!-- Report Form -->
    <section class="py-8 bg-gray-50">
        <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Stepper -->
            <div class="mb-8">
                <div class="flex items-center">
                    <div class="stepper-circle stepper-active">1</div>
                    <div class="flex-1 h-0.5 bg-gray-200 mx-4"></div>
                    <div class="stepper-circle stepper-inactive">2</div>
                    <div class="flex-1 h-0.5 bg-gray-200 mx-4"></div>
                    <div class="stepper-circle stepper-inactive">3</div>
                    <div class="flex-1 h-0.5 bg-gray-200 mx-4"></div>
                    <div class="stepper-circle stepper-inactive">4</div>
                </div>
                <div class="flex justify-between mt-2">
                    <span class="text-sm font-medium text-green-600">Choose Type</span>
                    <span class="text-sm font-medium text-gray-500">Add Details</span>
                    <span class="text-sm font-medium text-gray-500">Upload Photo</span>
                    <span class="text-sm font-medium text-gray-500">Submit</span>
                </div>
            </div>

            <!-- Step 1: Choose Issue Type -->
            <div id="step-1" class="bg-white rounded-xl shadow-sm p-6 step-content">
                <h3 class="text-lg font-medium text-gray-900 mb-4">What type of issue are you reporting?</h3>
                <div class="grid grid-cols-2 gap-4">
                    <button type="button" class="issue-tile p-4 border border-gray-200 rounded-lg flex flex-col items-center issue-type-btn" data-type="Accident">
                        <div class="bg-red-100 p-3 rounded-full mb-2">
                            <i data-feather="alert-triangle" class="text-red-500 w-6 h-6"></i>
                        </div>
                        <span class="font-medium">Accident</span>
                    </button>
                    <button type="button" class="issue-tile p-4 border border-gray-200 rounded-lg flex flex-col items-center issue-type-btn" data-type="Roadblock">
                        <div class="bg-orange-100 p-3 rounded-full mb-2">
                            <i data-feather="x-octagon" class="text-orange-500 w-6 h-6"></i>
                        </div>
                        <span class="font-medium">Roadblock</span>
                    </button>
                    <button type="button" class="issue-tile p-4 border border-gray-200 rounded-lg flex flex-col items-center issue-type-btn" data-type="Pothole">
                        <div class="bg-yellow-100 p-3 rounded-full mb-2">
                            <i data-feather="alert-circle" class="text-yellow-500 w-6 h-6"></i>
                        </div>
                        <span class="font-medium">Pothole</span>
                    </button>
                    <button type="button" class="issue-tile p-4 border border-gray-200 rounded-lg flex flex-col items-center issue-type-btn" data-type="Flooding">
                        <div class="bg-blue-100 p-3 rounded-full mb-2">
                            <i data-feather="droplet" class="text-blue-500 w-6 h-6"></i>
                        </div>
                        <span class="font-medium">Flooding</span>
                    </button>
                </div>

                <!-- Emergency Contacts -->
                <div id="emergencyContacts" class="mt-6 space-y-2 hidden">
                    <div id="ambulanceContact" class="p-3 rounded-lg bg-red-100 text-red-800 font-semibold flex items-center hidden">
                        üöë <span class="ml-2">Emergency: Call Ambulance <a href="tel:108" class="underline font-bold">108</a></span>
                    </div>
                    <div id="policeContact" class="p-3 rounded-lg bg-blue-100 text-blue-800 font-semibold flex items-center hidden">
                        üöì <span class="ml-2">Traffic Police: <a href="tel:100" class="underline font-bold">100</a></span>
                    </div>
                    <div id="fireContact" class="p-3 rounded-lg bg-yellow-100 text-yellow-800 font-semibold flex items-center hidden">
                        üöí <span class="ml-2">Fire & Rescue: <a href="tel:101" class="underline font-bold">101</a></span>
                    </div>
                    <div id="municipalityContact" class="p-3 rounded-lg bg-green-100 text-green-800 font-semibold flex items-center hidden">
                        üèõÔ∏è <span class="ml-2">Municipality: <a href="tel:0493-3271000" class="underline font-bold">0493-3271000</a></span>
                    </div>
                </div>

                <div class="mt-6 flex justify-end">
                    <button type="button" id="step1Next" class="px-6 py-2 border border-transparent text-base font-medium rounded-full text-white bg-green-600 hover:bg-green-700 step-next opacity-50 cursor-not-allowed" disabled>
                        Next: Add Details
                    </button>
                </div>
            </div>

            <!-- Step 2: Add Details -->
            <div id="step-2" class="bg-white rounded-xl shadow-sm p-6 mt-6 step-content hidden">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Describe the issue</h3>
                
                <!-- Speech-to-Text Section -->
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-sm font-medium text-gray-700">Description</label>
                        <button type="button" id="speechBtn" class="flex items-center text-green-600 hover:text-green-700">
                            <i data-feather="mic" class="w-4 h-4 mr-1"></i>
                            <span id="speechBtnText">Speak</span>
                        </button>
                    </div>
                    <textarea id="issueDescription" rows="4" class="block w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" placeholder="Describe the issue in detail or click the microphone to speak..."></textarea>
                    <div id="speechStatus" class="mt-2 text-sm text-gray-500 hidden">
                        <span class="speech-indicator">üé§ Listening...</span>
                    </div>
                </div>

                                                        <!-- Location Section -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Pin Issue Location</label>
                        
                        <!-- Map for Location Pinning -->
                        <div class="mb-3 relative">
                            <div id="locationMap" class="w-full h-64 rounded-lg border border-gray-300" style="background-color: #f3f4f6;"></div>
                            
                            <!-- Click to Pin Overlay -->
                            <div id="clickToPinOverlay" class="absolute inset-0 flex items-center justify-center pointer-events-none z-10">
                                <div class="bg-white bg-opacity-95 rounded-lg px-6 py-3 shadow-xl border-2 border-red-200 pin-pulse pointer-events-none">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-8 h-8">
                                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z" 
                                                      fill="#EF4444" stroke="#DC2626" stroke-width="1"/>
                                                <circle cx="12" cy="9" r="2.5" fill="#FEE2E2"/>
                                            </svg>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-sm font-bold text-gray-800">Click anywhere on the map</div>
                                            <div class="text-xs text-gray-600">to pin the issue location</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Test Button for Debugging -->
                            <button id="testPinButton" class="absolute top-2 right-2 bg-blue-500 text-white px-3 py-1 rounded text-sm z-20" onclick="testPinLocation()">
                                Test Pin
                            </button>
                            
                            <p class="text-xs text-gray-500 mt-1">Click on the map to pin the exact location of the issue</p>
                        </div>
                        
                        <!-- Location Information Display -->
                        <div id="locationInfo" class="hidden space-y-3">
                            <!-- Coordinates Display -->
                            <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                <div class="flex items-center mb-2">
                                    <i data-feather="map-pin" class="w-4 h-4 text-blue-600 mr-2"></i>
                                    <span class="text-sm font-medium text-blue-900">GPS Coordinates</span>
                                </div>
                                <div class="grid grid-cols-2 gap-2 text-sm">
                                    <div>
                                        <span class="text-blue-700">Latitude:</span>
                                        <span id="latitudeText" class="font-mono font-medium text-blue-900">--</span>
                                    </div>
                                    <div>
                                        <span class="text-blue-700">Longitude:</span>
                                        <span id="longitudeText" class="font-mono font-medium text-blue-900">--</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Address Display -->
                            <div class="p-3 bg-green-50 border border-green-200 rounded-lg">
                                <div class="flex items-center mb-2">
                                    <i data-feather="home" class="w-4 h-4 text-green-600 mr-2"></i>
                                    <span class="text-sm font-medium text-green-900">Address</span>
                                </div>
                                <div id="addressText" class="text-sm text-green-800">Click on the map to select location</div>
                            </div>
                            
                            <!-- Distance from Kottakkal Center -->
                            <div class="p-3 bg-purple-50 border border-purple-200 rounded-lg">
                                <div class="flex items-center mb-2">
                                    <i data-feather="navigation" class="w-4 h-4 text-purple-600 mr-2"></i>
                                    <span class="text-sm font-medium text-purple-900">Distance from Kottakkal Center</span>
                                </div>
                                <div id="distanceText" class="text-sm text-purple-800">--</div>
                            </div>
                        </div>
                        
                        <!-- No Location Selected Warning -->
                        <div id="noLocationWarning" class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <div class="flex items-center">
                                <i data-feather="alert-triangle" class="w-4 h-4 text-yellow-600 mr-2"></i>
                                <span class="text-sm text-yellow-800">Please click on the map to select the issue location before proceeding</span>
                            </div>
                        </div>
                    </div>

                <!-- Fake Report Detection -->
                <div id="fakeReportWarning" class="p-4 rounded-lg bg-yellow-50 border border-yellow-200 hidden">
                    <div class="flex items-center">
                        <i data-feather="alert-triangle" class="text-yellow-500 w-5 h-5 mr-2"></i>
                        <div>
                            <h4 class="font-medium text-yellow-800">Potential Duplicate Report</h4>
                            <p class="text-sm text-yellow-700">A similar report was submitted recently. Please verify this is a new issue.</p>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-center">
                    <button type="button" class="px-6 py-2 border border-gray-300 text-base font-medium rounded-full text-gray-700 bg-white hover:bg-gray-50 step-back">
                        Back
                    </button>
                    <div class="text-right">
                        <button type="button" id="step2Next" class="px-6 py-2 border border-transparent text-base font-medium rounded-full text-white bg-green-600 hover:bg-green-700 step-next opacity-50 cursor-not-allowed" disabled>
                            Next: Upload Photo
                        </button>
                        <div id="nextButtonHelp" class="text-xs text-gray-500 mt-1">
                            Pin a location on the map to continue
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Upload Photo -->
            <div id="step-3" class="bg-white rounded-xl shadow-sm p-6 mt-6 step-content hidden">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Upload a Photo (Optional)</h3>
                
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                    <i data-feather="camera" class="w-12 h-12 text-gray-400 mx-auto mb-4"></i>
                    <p class="text-gray-600 mb-2">Drag and drop a photo here, or</p>
                    <input type="file" id="photoUpload" accept="image/*" class="hidden">
                    <button type="button" onclick="document.getElementById('photoUpload').click()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        Choose File
                    </button>
                </div>

                <div id="photoPreview" class="mt-4 hidden">
                    <img id="previewImage" class="w-full h-48 object-cover rounded-lg" alt="Preview">
                </div>

                <div class="flex justify-between mt-6">
                    <button type="button" class="px-6 py-2 border border-gray-300 text-base font-medium rounded-full text-gray-700 bg-white hover:bg-gray-50 step-back">
                        Back
                    </button>
                    <button type="button" id="step3Next" class="px-6 py-2 border border-transparent text-base font-medium rounded-full text-white bg-green-600 hover:bg-green-700 step-next">
                        Next: Submit
                    </button>
                </div>
            </div>

            <!-- Step 4: Submit -->
            <div id="step-4" class="bg-white rounded-xl shadow-sm p-6 mt-6 step-content hidden">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Review & Submit</h3>
                
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <h4 class="font-medium text-gray-900 mb-3">Report Summary</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Issue Type:</span>
                            <span id="summaryType" class="font-medium">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Location:</span>
                            <span id="summaryLocation" class="font-medium">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Description:</span>
                            <span id="summaryDescription" class="font-medium">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Photo:</span>
                            <span id="summaryPhoto" class="font-medium">--</span>
                        </div>
                    </div>
                </div>

                <!-- Karma Points Preview -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                    <div class="flex items-center">
                        <i data-feather="award" class="text-green-600 w-5 h-5 mr-2"></i>
                        <div>
                            <h4 class="font-medium text-green-800">Karma Points</h4>
                            <p class="text-sm text-green-700">You'll earn <span class="font-bold">10 points</span> for this valid report!</p>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between">
                    <button type="button" class="px-6 py-2 border border-gray-300 text-base font-medium rounded-full text-gray-700 bg-white hover:bg-gray-50 step-back">
                        Back
                    </button>
                    <button type="submit" id="submitReport" class="px-6 py-2 border border-transparent text-base font-medium rounded-full text-white bg-green-600 hover:bg-green-700">
                        Submit Report
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200">
        <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center">
                <p class="text-gray-500">¬© 2023 Smart Traffic Monitor ‚Äì Kottakkal. Reports are stored locally and synced when online.</p>
                <a href="index.html" class="text-green-600 hover:text-green-700">Back to Home</a>
            </div>
        </div>
    </footer>

    <script>
        // Initialize Feather Icons
        feather.replace();

        // Global variables
        let currentStep = 0;
        let selectedIssueType = null;
        let recognition = null;
        let isListening = false;
        let offlineReports = [];
        let locationMap = null;
        let locationMarker = null;
        let pinnedLocation = null;

        // Check online status
        function checkOnlineStatus() {
            const offlineIndicator = document.getElementById('offlineIndicator');
            if (!navigator.onLine) {
                offlineIndicator.classList.remove('hidden');
            } else {
                offlineIndicator.classList.add('hidden');
                // Sync offline reports
                syncOfflineReports();
            }
        }

        // Initialize location map
        function initLocationMap() {
            const mapContainer = document.getElementById('locationMap');
            if (!mapContainer) {
                console.error('Map container not found');
                return;
            }

            // Check if Google Maps API is loaded
            if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
                console.error('Google Maps API not loaded');
                mapContainer.innerHTML = `
                    <div class="w-full h-full bg-gray-200 flex items-center justify-center">
                        <div class="text-center">
                            <i data-feather="map" class="w-16 h-16 mx-auto mb-4 text-gray-400"></i>
                            <p class="text-gray-600">Loading map...</p>
                            <p class="text-sm text-gray-500 mt-2">Please wait while the map loads</p>
                        </div>
                    </div>
                `;
                feather.replace();
                
                // Retry after a short delay
                setTimeout(initLocationMap, 1000);
                return;
            }

            // Kottakkal coordinates (center of Kottakkal town)
            const kottakkal = { lat: 10.9942, lng: 76.0062 };

            try {
                // Create map centered on Kottakkal
                locationMap = new google.maps.Map(mapContainer, {
                    zoom: 15,
                    center: kottakkal,
                    mapTypeId: google.maps.MapTypeId.ROADMAP,
                    mapTypeControl: false,
                    streetViewControl: false,
                    fullscreenControl: false,
                    zoomControl: true,
                    scrollwheel: true,
                    styles: [
                        {
                            featureType: "poi",
                            elementType: "labels",
                            stylers: [{ visibility: "off" }]
                        }
                    ]
                });

                // Add click listener to map
                locationMap.addListener('click', function(event) {
                    console.log('Map clicked at:', event.latLng.lat(), event.latLng.lng());
                    placeLocationMarker(event.latLng);
                });

                // Also add a direct click listener to the map container as backup
                mapContainer.addEventListener('click', function(event) {
                    console.log('Map container clicked');
                    // Don't handle here, let the map handle it
                });

                // Add a test click to verify the map is working
                console.log('Map initialized successfully, click listeners added');

            // Add Kottakkal boundary indicator
            const kottakkalBoundary = new google.maps.Circle({
                strokeColor: '#3CB371',
                strokeOpacity: 0.3,
                strokeWeight: 2,
                fillColor: '#3CB371',
                fillOpacity: 0.1,
                map: locationMap,
                center: kottakkal,
                radius: 2000 // 2km radius around Kottakkal center
            });

            // Add Kottakkal center marker
            const centerMarker = new google.maps.Marker({
                position: kottakkal,
                map: locationMap,
                title: 'Kottakkal Center',
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="10" fill="#3CB371" stroke="white" stroke-width="2"/>
                            <text x="12" y="16" text-anchor="middle" fill="white" font-size="10" font-weight="bold">K</text>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(24, 24),
                    anchor: new google.maps.Point(12, 12)
                }
            });

            // Add important Kottakkal landmarks
            const landmarks = [
                {
                    position: { lat: 10.9942, lng: 76.0062 },
                    title: 'Kottakkal Center',
                    icon: 'üèõÔ∏è'
                },
                {
                    position: { lat: 10.9842, lng: 76.0162 },
                    title: 'Kottakkal Medical College',
                    icon: 'üè•'
                },
                {
                    position: { lat: 11.0042, lng: 75.9962 },
                    title: 'Kottakkal Bypass Road',
                    icon: 'üõ£Ô∏è'
                },
                {
                    position: { lat: 10.9742, lng: 76.0262 },
                    title: 'Main Bazaar Road',
                    icon: 'üõçÔ∏è'
                },
                {
                    position: { lat: 11.0142, lng: 75.9862 },
                    title: 'NH 66',
                    icon: 'üõ£Ô∏è'
                }
            ];

            landmarks.forEach(landmark => {
                const marker = new google.maps.Marker({
                    position: landmark.position,
                    map: locationMap,
                    title: landmark.title,
                    icon: {
                        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="10" cy="10" r="8" fill="#3B82F6" stroke="white" stroke-width="1"/>
                                <text x="10" y="13" text-anchor="middle" fill="white" font-size="8">${landmark.icon}</text>
                            </svg>
                        `),
                        scaledSize: new google.maps.Size(20, 20),
                        anchor: new google.maps.Point(10, 10)
                    }
                });

                // Add info window for landmarks
                const infoWindow = new google.maps.InfoWindow({
                    content: `<div class="p-2"><strong>${landmark.title}</strong></div>`
                });

                marker.addListener('click', function() {
                    infoWindow.open(locationMap, marker);
                });
            });

            // Try to get user's current location, but stay within Kottakkal area
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        // Check if user is within Kottakkal area (within 5km)
                        const distance = google.maps.geometry.spherical.computeDistanceBetween(
                            new google.maps.LatLng(kottakkal),
                            new google.maps.LatLng(userLocation)
                        );
                        
                        if (distance <= 5000) { // Within 5km of Kottakkal
                            locationMap.setCenter(userLocation);
                            placeLocationMarker(userLocation);
                        } else {
                            // User is outside Kottakkal area, center on Kottakkal
                            placeLocationMarker(kottakkal);
                        }
                    },
                    function() {
                        // If geolocation fails, center on Kottakkal
                        placeLocationMarker(kottakkal);
                    }
                );
            } else {
                // Fallback to Kottakkal
                placeLocationMarker(kottakkal);
            }
            } catch (error) {
                console.error('Error initializing map:', error);
                mapContainer.innerHTML = `
                    <div class="w-full h-full bg-red-50 flex items-center justify-center">
                        <div class="text-center">
                            <i data-feather="alert-triangle" class="w-16 h-16 mx-auto mb-4 text-red-400"></i>
                            <p class="text-red-600">Failed to load map</p>
                            <p class="text-sm text-red-500 mt-2">Please refresh the page and try again</p>
                        </div>
                    </div>
                `;
                feather.replace();
            }
        }

        // Place location marker on map
        function placeLocationMarker(latLng) {
            console.log('Placing marker at:', latLng.lat(), latLng.lng());
            
            // Check if map is available
            if (!locationMap) {
                console.error('Map not initialized');
                return;
            }

            // Remove existing marker
            if (locationMarker) {
                locationMarker.setMap(null);
            }

            try {
                            // Create new marker
            locationMarker = new google.maps.Marker({
                position: latLng,
                map: locationMap,
                draggable: true,
                title: 'Issue Location',
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <!-- Pin shadow -->
                            <ellipse cx="20" cy="38" rx="6" ry="2" fill="rgba(0,0,0,0.3)"/>
                            
                            <!-- Pin body -->
                            <path d="M20 4C14.48 4 10 8.48 10 14c0 7 10 22 10 22s10-15 10-22c0-5.52-4.48-10-10-10z" 
                                  fill="#EF4444" stroke="#DC2626" stroke-width="1"/>
                            
                            <!-- Pin highlight -->
                            <path d="M16 8c0-2.21 1.79-4 4-4s4 1.79 4 4-1.79 4-4 4-4-1.79-4-4z" 
                                  fill="#FEE2E2"/>
                            
                            <!-- Pin center dot -->
                            <circle cx="20" cy="12" r="2" fill="#DC2626"/>
                            
                            <!-- Pin tip -->
                            <path d="M20 16l-2 8h4l-2-8z" fill="#DC2626"/>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(40, 40),
                    anchor: new google.maps.Point(20, 40) // Anchor at the bottom tip of the pin
                }
            });

            // Store pinned location
            pinnedLocation = {
                lat: latLng.lat(),
                lng: latLng.lng()
            };

            // Update coordinates display
            updateCoordinatesDisplay(latLng);

            // Add drag listener
            locationMarker.addListener('dragend', function(event) {
                pinnedLocation = {
                    lat: event.latLng.lat(),
                    lng: event.latLng.lng()
                };
                updateCoordinatesDisplay(event.latLng);
                
                // Update location input when marker is dragged
                const locationInput = document.getElementById('issueLocation');
                if (locationInput) {
                    // Clear the input first to allow new address to be filled
                    locationInput.value = '';
                    // The updateCoordinatesDisplay function will fill it with the new address
                }
            });

            // Show coordinates display
            document.getElementById('coordinatesDisplay').classList.remove('hidden');
            } catch (error) {
                console.error('Error placing marker:', error);
                alert('Error placing marker. Please try again.');
            }
        }

        // Update coordinates display
        function updateCoordinatesDisplay(latLng) {
            // Update latitude and longitude separately
            document.getElementById('latitudeText').textContent = latLng.lat().toFixed(6);
            document.getElementById('longitudeText').textContent = latLng.lng().toFixed(6);

            // Calculate distance from Kottakkal center
            const kottakkalCenter = new google.maps.LatLng(10.9942, 76.0062);
            const distance = google.maps.geometry.spherical.computeDistanceBetween(
                kottakkalCenter,
                latLng
            );
            
            // Update distance display
            const distanceText = document.getElementById('distanceText');
            if (distance < 1000) {
                distanceText.textContent = `${Math.round(distance)} meters from Kottakkal Center`;
            } else {
                distanceText.textContent = `${(distance / 1000).toFixed(1)} km from Kottakkal Center`;
            }

            // Reverse geocoding to get address
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ location: latLng }, function(results, status) {
                if (status === 'OK' && results[0]) {
                    const addressText = document.getElementById('addressText');
                    addressText.textContent = results[0].formatted_address;
                } else {
                    document.getElementById('addressText').textContent = 'Address not available';
                }
            });

            // Show location info and hide warning
            document.getElementById('locationInfo').classList.remove('hidden');
            document.getElementById('noLocationWarning').classList.add('hidden');
            
            // Hide the click to pin overlay
            const overlay = document.getElementById('clickToPinOverlay');
            if (overlay) {
                overlay.classList.add('hidden');
            }
            
            // Enable the Next button when location is pinned
            const nextButton = document.getElementById('step2Next');
            if (nextButton) {
                nextButton.disabled = false;
                nextButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            
            // Hide the help text
            const helpText = document.getElementById('nextButtonHelp');
            if (helpText) {
                helpText.classList.add('hidden');
            }
        }



        // Test function to verify pinning works
        function testPinLocation() {
            console.log('Test pin function called');
            if (locationMap) {
                console.log('Map is available, testing pin at center');
                const center = locationMap.getCenter();
                placeLocationMarker(center);
            } else {
                console.error('Map not available');
                alert('Map not loaded yet. Please wait.');
            }
        }

        // Initialize speech recognition
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';

                recognition.onstart = function() {
                    isListening = true;
                    document.getElementById('speechStatus').classList.remove('hidden');
                    document.getElementById('speechBtnText').textContent = 'Stop';
                    document.getElementById('speechBtn').innerHTML = '<i data-feather="square" class="w-4 h-4 mr-1"></i>Stop';
                    feather.replace();
                };

                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('issueDescription').value = transcript;
                };

                recognition.onend = function() {
                    isListening = false;
                    document.getElementById('speechStatus').classList.add('hidden');
                    document.getElementById('speechBtnText').textContent = 'Speak';
                    document.getElementById('speechBtn').innerHTML = '<i data-feather="mic" class="w-4 h-4 mr-1"></i>Speak';
                    feather.replace();
                };

                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    isListening = false;
                    document.getElementById('speechStatus').classList.add('hidden');
                };
            } else {
                document.getElementById('speechBtn').style.display = 'none';
            }
        }

        // Stepper functionality
        function showStep(step) {
            document.querySelectorAll('.step-content').forEach((content, index) => {
                content.classList.toggle('hidden', index !== step);
            });

            document.querySelectorAll('.stepper-circle').forEach((circle, index) => {
                if (index <= step) {
                    circle.classList.remove('stepper-inactive');
                    circle.classList.add('stepper-active');
                } else {
                    circle.classList.remove('stepper-active');
                    circle.classList.add('stepper-inactive');
                }
            });

            currentStep = step;
            
            // Initialize map when step 2 is shown
            if (step === 1 && !locationMap) {
                setTimeout(initLocationMap, 100);
            }
            
            // Disable Next button on step 2 if no location is pinned
            if (step === 1) {
                const nextButton = document.getElementById('step2Next');
                if (nextButton && !pinnedLocation) {
                    nextButton.disabled = true;
                    nextButton.classList.add('opacity-50', 'cursor-not-allowed');
                }
            }
        }

        // Issue type selection
        document.querySelectorAll('.issue-type-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.issue-type-btn').forEach(b => {
                    b.classList.remove('ring-2', 'ring-green-500', 'border-green-500');
                });
                this.classList.add('ring-2', 'ring-green-500', 'border-green-500');
                
                selectedIssueType = this.getAttribute('data-type');
                document.getElementById('step1Next').disabled = false;
                document.getElementById('step1Next').classList.remove('opacity-50', 'cursor-not-allowed');

                // Show emergency contacts
                showEmergencyContacts(selectedIssueType);
            });
        });

        // Show emergency contacts based on issue type
        function showEmergencyContacts(issueType) {
            document.getElementById('emergencyContacts').classList.remove('hidden');
            document.querySelectorAll('#emergencyContacts > div').forEach(div => div.classList.add('hidden'));

            switch(issueType) {
                case 'Accident':
                    document.getElementById('ambulanceContact').classList.remove('hidden');
                    document.getElementById('policeContact').classList.remove('hidden');
                    break;
                case 'Roadblock':
                    document.getElementById('policeContact').classList.remove('hidden');
                    break;
                case 'Flooding':
                    document.getElementById('fireContact').classList.remove('hidden');
                    break;
                case 'Pothole':
                    document.getElementById('municipalityContact').classList.remove('hidden');
                    break;
            }
        }

        // Speech button functionality
        document.getElementById('speechBtn').addEventListener('click', function() {
            if (!recognition) return;

            if (isListening) {
                recognition.stop();
            } else {
                recognition.start();
            }
        });

        // Photo upload functionality
        document.getElementById('photoUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImage').src = e.target.result;
                    document.getElementById('photoPreview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        // Fake report detection
        function checkForDuplicateReport() {
            const description = document.getElementById('issueDescription').value.toLowerCase();
            const location = document.getElementById('issueLocation').value.toLowerCase();
            
            const existingReports = JSON.parse(localStorage.getItem('trafficReports')) || [];
            const recentReports = existingReports.filter(report => 
                Date.now() - report.timestamp < 3600000 // Last hour
            );

            const duplicate = recentReports.find(report => 
                (report.description && report.description.toLowerCase().includes(description.substring(0, 20))) ||
                (report.location && report.location.toLowerCase().includes(location.substring(0, 10)))
            );

            if (duplicate) {
                document.getElementById('fakeReportWarning').classList.remove('hidden');
            } else {
                document.getElementById('fakeReportWarning').classList.add('hidden');
            }
        }

        // Update summary
        function updateSummary() {
            document.getElementById('summaryType').textContent = selectedIssueType || '--';
            document.getElementById('summaryLocation').textContent = pinnedLocation ? document.getElementById('addressText').textContent : 'No location pinned';
            document.getElementById('summaryDescription').textContent = document.getElementById('issueDescription').value || '--';
            document.getElementById('summaryPhoto').textContent = document.getElementById('photoUpload').files[0] ? 'Yes' : 'No';
            
            // Add coordinates to summary if available
            if (pinnedLocation) {
                const coordinatesSummary = document.getElementById('summaryCoordinates') || 
                    document.createElement('div');
                coordinatesSummary.id = 'summaryCoordinates';
                coordinatesSummary.innerHTML = `
                    <div class="flex justify-between">
                        <span class="text-gray-600">Coordinates:</span>
                        <span class="font-medium">${pinnedLocation.lat.toFixed(6)}, ${pinnedLocation.lng.toFixed(6)}</span>
                    </div>
                    <div class="flex justify-between mt-1">
                        <span class="text-gray-600">Distance from Center:</span>
                        <span class="font-medium">${document.getElementById('distanceText').textContent}</span>
                    </div>
                `;
                
                const summaryContainer = document.querySelector('.bg-gray-50.rounded-lg.p-4.mb-6');
                if (summaryContainer && !document.getElementById('summaryCoordinates')) {
                    summaryContainer.appendChild(coordinatesSummary);
                }
            }
        }

        // Submit report
        function submitReport() {
            // Check if location is pinned
            if (!pinnedLocation) {
                alert('Please pin a location on the map before submitting the report.');
                return;
            }

            const report = {
                id: 'RPT-' + Date.now(),
                type: selectedIssueType,
                description: document.getElementById('issueDescription').value,
                location: document.getElementById('addressText').textContent,
                coordinates: pinnedLocation,
                photo: document.getElementById('photoUpload').files[0] ? 'Yes' : 'No',
                timestamp: Date.now(),
                status: 'pending'
            };

            if (navigator.onLine) {
                // Store in localStorage and show notification
                const reports = JSON.parse(localStorage.getItem('trafficReports')) || [];
                reports.push(report);
                localStorage.setItem('trafficReports', JSON.stringify(reports));

                // Award karma points
                const karma = parseInt(localStorage.getItem('karma') || 0) + 10;
                localStorage.setItem('karma', karma);

                alert('‚úÖ Report submitted successfully! You earned 10 karma points.');
                window.location.href = 'index.html';
            } else {
                // Store offline
                offlineReports.push(report);
                localStorage.setItem('offlineReports', JSON.stringify(offlineReports));
                alert('üì± Report saved offline. Will sync when connection returns.');
                window.location.href = 'index.html';
            }
        }

        // Sync offline reports
        function syncOfflineReports() {
            const offlineReports = JSON.parse(localStorage.getItem('offlineReports')) || [];
            if (offlineReports.length > 0) {
                const reports = JSON.parse(localStorage.getItem('trafficReports')) || [];
                reports.push(...offlineReports);
                localStorage.setItem('trafficReports', JSON.stringify(reports));
                localStorage.removeItem('offlineReports');
                
                // Award karma points for offline reports
                const karma = parseInt(localStorage.getItem('karma') || 0) + (offlineReports.length * 10);
                localStorage.setItem('karma', karma);
            }
        }

        // Event listeners
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('step-next')) {
                if (currentStep < 3) {
                    if (currentStep === 1) {
                        updateSummary();
                    }
                    showStep(currentStep + 1);
                }
            } else if (e.target.classList.contains('step-back')) {
                if (currentStep > 0) {
                    showStep(currentStep - 1);
                }
            }
        });

        document.getElementById('issueDescription').addEventListener('input', checkForDuplicateReport);
        document.getElementById('submitReport').addEventListener('click', submitReport);

        // Initialize
        window.addEventListener('load', function() {
            initSpeechRecognition();
            checkOnlineStatus();
            showStep(0);
        });

        window.addEventListener('online', checkOnlineStatus);
        window.addEventListener('offline', checkOnlineStatus);
    </script>
    
    <!-- Google Maps JavaScript API -->
    <script>
        // Global callback for Google Maps API
        function initGoogleMaps() {
            console.log('Google Maps API loaded successfully');
            // Initialize map when API is ready
            setTimeout(initLocationMap, 500);
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAvRof_vnY0uVk9TDMWauTxhWLDm6oiSDs&libraries=geometry,places&callback=initGoogleMaps" async defer></script>
</body>
</html> 